<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Clinic Queue System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f9; }
        .card { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .date-input { appearance: none; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 md:p-8 flex flex-col items-center">
    <div class="w-full max-w-4xl space-y-8">
        <h1 class="text-3xl font-extrabold text-gray-800 text-center">Swanand Clinic Queue System</h1>

        <!-- Initial/Loading/Sign-In Screen -->
        <div id="authScreen" class="card bg-white p-12 rounded-xl border border-gray-100 text-center space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700" id="authHeader">
                Loading...
            </h2>
            <p id="authMessage" class="text-gray-500">Please sign in with your email to access the queue system.</p>
            <button id="signInButton" onclick="signInWithGoogle()" 
                    class="hidden bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out disabled:bg-gray-400">
                <svg class="inline w-4 h-4 mr-2" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 19"><path fill-rule="evenodd" d="M8.842 18.083A8.347 8.347 0 0 1 8.8 14.052c0-1.01.332-2.076 1.054-2.92.51-.598.92-1.46.92-2.585 0-2.453-2.093-4.444-4.683-4.444-1.22 0-2.316.5-3.085 1.4-1.127 1.358-1.57 3.3-1.57 4.96 0 1.2.33 2.19.825 3.1 0 0 .822 1.353 1.34 2.155.66.995 1.155 1.583 1.155 2.126 0 .524.088.948-.216 1.558.106.115.228.225.36.335A8.8 8.8 0 0 0 8.842 18.083Z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M16.666 11.266c-.66.82-1.358 1.4-1.358 2.05 0 .55.1 1.05.32 1.558.07-.1.14-.2.23-.3a8.8 8.8 0 0 0 1.25-1.92c.5-.9.826-1.9.826-3.1 0-1.66-.442-3.6-1.57-4.96-.77-.9-1.87-1.4-3.09-1.4-2.59 0-4.68 2-4.68 4.445 0 1.125.41 1.987.92 2.585.72.844 1.054 1.91 1.054 2.92 0 1.06-.35 2.08-.94 2.97.23.2.49.38.77.56.24-.12.48-.24.7-.38.7-.46 1.15-.7 1.15-1.17 0-.36.08-.7-.2-1.08-.4-.48-.52-1.05-.52-1.85 0-2.6 2.09-4.7 4.68-4.7 1.22 0 2.32.5 3.09 1.4 1.13 1.358 1.57 3.3 1.57 4.96 0 1.2-.33 2.19-.825 3.1 0 0-1.07 1.83-1.34 2.155-.66.995-1.155 1.583-1.155 2.126 0 .524.088.948-.216 1.558.106.115.228.225.36.335A8.8 8.8 0 0 0 16.666 11.266Z" clip-rule="evenodd"/></svg>
                Sign in with Google
            </button>
        </div>

        <!-- AUTHENTICATED CONTENT (Hidden until login) -->
        <div id="authenticatedContent" class="hidden w-full space-y-8">
            <!-- Global Queue Status Display (Visible to all) -->
            <div id="queueStatusDisplay" class="p-3 rounded-xl font-semibold text-center border-b-4">Queue Status: Fetching...</div>

            <!-- Submission Form Card (Patient View) -->
            <div id="form-card" class="card bg-white p-6 rounded-xl border border-gray-100 transition-all duration-300">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Join the Queue (Today: <span id="todayDate"></span>)</h2>
                <form id="queueForm" onsubmit="submitPatient(event)">
                    
                    <!-- Patient Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">1. Name</label>
                            <input type="text" id="name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="village" class="block text-sm font-medium text-gray-700 mb-1">2. Village</label>
                            <input type="text" id="village" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <!-- Patient Type -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">3. Type of Patient</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="patientType" value="New" onclick="toggleSubOptions(false)" required class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">a) New</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="patientType" value="Old" onclick="toggleSubOptions(true)" class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">b) Old</span>
                            </label>
                        </div>
                    </div>

                    <!-- Old Patient Sub-Options (Hidden by default) -->
                    <div id="oldPatientOptions" class="border border-l-4 border-blue-400 p-4 mb-6 rounded-lg bg-blue-50 hidden">
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Select Old Patient Details</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="subType" value="Within 6 Months" class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">b1) Shown within 6 months</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="subType" value="After 6 Months" class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">b2) Showing after 6 months</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="statusMessage" class="mb-4 p-3 rounded-lg text-sm font-medium hidden" role="alert"></div>

                    <button type="submit" id="submitButton" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 ease-in-out disabled:bg-gray-400">
                        Join Queue
                    </button>
                </form>
            </div>

            <!-- Patient Queue Number Card (Personal View) -->
            <div id="patient-queue-card" class="card bg-blue-600 text-white p-6 rounded-xl text-center border-4 border-blue-400 hidden">
                <p class="text-lg font-medium mb-1">Welcome, <span id="myName" class="font-bold">Patient</span>!</p>
                <p class="text-sm font-medium mb-3">Your Current Queue Position:</p>
                <p id="myQueueNumber" class="text-7xl font-extrabold">--</p>
                <p id="myStatusDetail" class="text-sm font-light mt-2"></p>
            </div>

            <!-- Receptionist Queue Control Panel (Only visible in Receptionist Mode) -->
            <div id="receptionistControlPanel" class="card bg-yellow-50 p-6 rounded-xl border-4 border-yellow-300 hidden">
                <h2 class="text-xl font-semibold text-yellow-800 mb-4">Queue Management</h2>
                
                <div class="mb-4">
                    <label for="queueDate" class="block text-sm font-medium text-yellow-700 mb-2">Queue Date Control:</label>
                    <input type="date" id="queueDate" onchange="setupQueueStatusListener(true)" class="date-input w-full p-2 border border-yellow-400 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-white">
                </div>

                <div class="flex flex-wrap gap-4 mb-4">
                    <button onclick="updateQueueStatus('Open')" class="flex-1 bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition duration-150 disabled:opacity-50" id="openQueueBtn">
                        Open Queue for Selected Date
                    </button>
                    <button onclick="updateQueueStatus('Closed')" class="flex-1 bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition duration-150 disabled:opacity-50" id="closeQueueBtn">
                        Close Queue for Selected Date
                    </button>
                </div>
                <p class="text-sm text-yellow-700" id="receptionistStatus">
                    Queue status for <span class="font-bold" id="selectedDateDisplay"></span> is: <span class="font-bold" id="controlStatusText">Open</span>.
                </p>
            </div>

            <!-- Real-Time Queue Display Card (Only visible to Receptionist) -->
            <div id="queueDisplayCard" class="card bg-white p-6 rounded-xl border border-gray-100 hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                    Live Patient Queue (Receptionist View)
                    <span id="queueCount" class="text-sm font-normal text-blue-500">0 Waiting</span>
                </h2>
                
                <div id="queueList" class="space-y-3">
                    <p id="emptyMessage" class="text-gray-500 text-center py-4">The queue is currently empty. Be the first!</p>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    // !!! IMPORTANT: UPDATE THIS ARRAY WITH YOUR RECEPTIONIST'S DEDICATED GOOGLE EMAILS !!!
    // Also, you MUST authorize your domain (www.swanandclinic.com) in your Firebase Console
    const RECEPTIONIST_EMAILS = [
        "receptionist1@example.com", // REPLACE THIS
        "receptionist2@example.com"  // REPLACE THIS
        // Add all authorized emails here
    ];
    // ----------------------------------------------------------------------------------

    // --- GLOBAL FIREBASE CONFIGURATION (MANDATORY) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    
    let app, db, auth, userId = null;
    let userEmail = null;
    let isAuthenticated = false;
    let unsubscribeQueue = null;
    let unsubscribeStatus = null;
    const MAX_PATIENT_SUBMISSIONS = 3;
    let isReceptionistMode = false;
    let isQueueOpen = true; // State of the overall queue for TODAY
    let todayYYYYMMDD = getTodayDateString(); // YYYY-MM-DD
    let controlDateYYYYMMDD = todayYYYYMMDD; // Date controlled by receptionist
    // ----------------------------------------------------

    const authScreen = document.getElementById('authScreen');
    const authHeader = document.getElementById('authHeader');
    const authMessage = document.getElementById('authMessage');
    const signInButton = document.getElementById('signInButton');
    const authenticatedContent = document.getElementById('authenticatedContent');
    const formCard = document.getElementById('form-card');
    const patientQueueCard = document.getElementById('patient-queue-card');
    const receptionistControlPanel = document.getElementById('receptionistControlPanel');
    const queueDisplayCard = document.getElementById('queueDisplayCard');

    // Other element references (kept for functionality)
    const oldPatientOptions = document.getElementById('oldPatientOptions');
    const statusMessage = document.getElementById('statusMessage');
    const queueList = document.getElementById('queueList');
    const emptyMessage = document.getElementById('emptyMessage');
    const submitButton = document.getElementById('submitButton');
    const myQueueNumber = document.getElementById('myQueueNumber');
    const myStatusDetail = document.getElementById('myStatusDetail');
    const myName = document.getElementById('myName');
    const queueCount = document.getElementById('queueCount');
    const queueStatusDisplay = document.getElementById('queueStatusDisplay');
    const openQueueBtn = document.getElementById('openQueueBtn');
    const closeQueueBtn = document.getElementById('closeQueueBtn');
    const queueDateInput = document.getElementById('queueDate');
    const selectedDateDisplay = document.getElementById('selectedDateDisplay');
    const controlStatusText = document.getElementById('controlStatusText');
    const todayDateSpan = document.getElementById('todayDate');

    // --- DATE UTILITIES ---
    function getTodayDateString() {
        const now = new Date();
        return now.toISOString().split('T')[0]; // Format YYYY-MM-DD
    }
    
    function formatDateDisplay(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        // Use try-catch for date parsing robustness, especially with input fields
        try {
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch (e) {
            return dateString;
        }
    }

    // --- UTILITY FUNCTIONS ---

    window.toggleSubOptions = (show) => {
        if (show) {
            oldPatientOptions.classList.remove('hidden');
            document.querySelectorAll('input[name="subType"]').forEach(el => el.required = true);
        } else {
            oldPatientOptions.classList.add('hidden');
            document.querySelectorAll('input[name="subType"]').forEach(el => el.required = false);
            document.querySelectorAll('input[name="subType"]').forEach(el => el.checked = false);
        }
    };
    
    function displayStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
        
        if (type === 'error') {
            statusMessage.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
            statusMessage.classList.add('bg-green-100', 'text-green-700');
        } else {
            statusMessage.classList.add('bg-yellow-100', 'text-yellow-700');
        }
    }

    // --- AUTHENTICATION & ROLE CHECK ---

    window.signInWithGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try {
            // Sign in using a popup
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Google Sign-In Error:", error);
            authHeader.textContent = "Sign In Failed";
            
            if (error.code === 'auth/unauthorized-domain') {
                authMessage.innerHTML = `
                    <p class="text-red-600 font-semibold mb-2">CRITICAL ERROR: Unauthorized Domain.</p>
                    <p>You must add the domain where this application is hosted (e.g., <code>www.swanandclinic.com</code>) to your Firebase project's **Authorized Domains** list.</p>
                    <ul class="list-disc list-inside mt-2 text-left mx-auto max-w-sm">
                        <li>Go to your **Firebase Console**.</li>
                        <li>Navigate to **Authentication** -> **Settings**.</li>
                        <li>Under **Authorized Domains**, click 'Add domain'.</li>
                        <li>Add your website's domain, e.g., <code>swanandclinic.com</code>.</li>
                    </ul>
                `;
            } else if (error.message.includes('popup')) {
                authMessage.textContent = "Sign in process interrupted (popup closed or blocked). Please ensure pop-ups are allowed and try again.";
            } else {
                authMessage.textContent = `Authentication Error: ${error.message}`;
            }
        }
    }

    const checkUserRole = (user) => {
        isAuthenticated = !!user;
        if (user) {
            userEmail = user.email;
            userId = user.uid;
            
            // Determine role
            isReceptionistMode = RECEPTIONIST_EMAILS.includes(userEmail);
            
            // Update UI based on role
            renderAuthenticatedUI();
            
            // Start data listeners
            // Pass true to setupQueueStatusListener to initialize controlDate for receptionist if needed
            setupQueueStatusListener(true); 
            updateQueueListener(); 

        } else {
            // Not logged in or logged out
            isReceptionistMode = false;
            userId = null;
            userEmail = null;
            renderUnauthenticatedUI();
            // Clear listeners when signing out
            if (unsubscribeStatus) unsubscribeStatus();
            if (unsubscribeQueue) unsubscribeQueue();
        }
    }

    const renderAuthenticatedUI = () => {
        authScreen.classList.add('hidden');
        authenticatedContent.classList.remove('hidden');
        
        // Show/Hide role-specific cards
        formCard.classList.toggle('hidden', isReceptionistMode);
        patientQueueCard.classList.toggle('hidden', isReceptionistMode);
        
        receptionistControlPanel.classList.toggle('hidden', !isReceptionistMode);
        queueDisplayCard.classList.toggle('hidden', !isReceptionistMode);
        
        // Setup dates for UI
        todayDateSpan.textContent = formatDateDisplay(todayYYYYMMDD);
        queueDateInput.value = todayYYYYMMDD;
        selectedDateDisplay.textContent = formatDateDisplay(controlDateYYYYMMDD);
    };

    const renderUnauthenticatedUI = () => {
        authScreen.classList.remove('hidden');
        authenticatedContent.classList.add('hidden');
        authHeader.textContent = "Welcome to Swanand Clinic Queue";
        authMessage.textContent = "Please sign in with your registered email to join the queue or manage patients.";
        signInButton.classList.remove('hidden');
    }

    // --- FIREBASE INITIALIZATION & AUTH ---

    function initializeFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            authHeader.textContent = "System Error";
            authMessage.textContent = "Firebase configuration failed to load.";
            return;
        }
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Main entry point after Firebase is initialized
        onAuthStateChanged(auth, checkUserRole);
    }
    
    // --- FIREBASE PATHS ---
    
    const getQueueCollectionRef = () => {
        return collection(db, 'artifacts', appId, 'public', 'data', 'patient_queue');
    };

    const getSettingsDocRef = (date) => {
        const dateKey = date || todayYYYYMMDD;
        return doc(db, 'artifacts', appId, 'public', 'data', 'queue_statuses', dateKey);
    };

    // --- QUEUE STATUS MANAGEMENT ---

    const setupQueueStatusListener = (isReceptionistUpdate = false) => {
        if (unsubscribeStatus) unsubscribeStatus();
        if (!isAuthenticated) return;

        if (isReceptionistUpdate && isReceptionistMode) {
            controlDateYYYYMMDD = queueDateInput.value;
            selectedDateDisplay.textContent = formatDateDisplay(controlDateYYYYMMDD);
        } else if (!isReceptionistUpdate && !isReceptionistMode) {
             controlDateYYYYMMDD = todayYYYYMMDD;
        }
        
        // Target date for the listener is dynamic based on mode
        const targetDate = isReceptionistMode ? controlDateYYYYMMDD : todayYYYYMMDD;
        
        unsubscribeStatus = onSnapshot(getSettingsDocRef(targetDate), (docSnapshot) => {
            const data = docSnapshot.data();
            const status = data?.status || 'Open'; 
            
            if (targetDate === todayYYYYMMDD) {
                // This updates the patient's view and submission form
                isQueueOpen = status === 'Open';
                renderQueueStatus(targetDate, status);
            }

            if (isReceptionistMode && targetDate === controlDateYYYYMMDD) {
                // This updates the receptionist control panel display
                controlStatusText.textContent = status;
                openQueueBtn.disabled = status === 'Open';
                closeQueueBtn.disabled = status === 'Closed';
                // If the receptionist is viewing today's queue, also update the global display
                if (targetDate === todayYYYYMMDD) {
                    renderQueueStatus(targetDate, status);
                }
            }
        }, (error) => {
            console.error("Error listening to queue status:", error);
        });
    }

    const renderQueueStatus = (date, status) => {
        const display = queueStatusDisplay;
        submitButton.disabled = !isQueueOpen && !isReceptionistMode;
        
        const dateDisplay = formatDateDisplay(date);

        if (status === 'Open') {
            display.textContent = `Queue Status for ${dateDisplay}: OPEN`;
            display.classList.remove('bg-red-100', 'text-red-700', 'border-red-400');
            display.classList.add('bg-green-100', 'text-green-700', 'border-green-400');
            if (!isReceptionistMode) submitButton.textContent = "Join Queue";
        } else {
            display.textContent = `Queue Status for ${dateDisplay}: CLOSED`;
            display.classList.remove('bg-green-100', 'text-green-700', 'border-green-400');
            display.classList.add('bg-red-100', 'text-red-700', 'border-red-400');
            if (!isReceptionistMode) submitButton.textContent = "Queue Closed";
        }
    };

    window.updateQueueStatus = async (status) => {
        if (!isReceptionistMode) return;
        
        const docRef = getSettingsDocRef(controlDateYYYYMMDD);
        
        try {
            await setDoc(docRef, { 
                status: status, 
                timestamp: serverTimestamp(), 
                date: controlDateYYYYMMDD,
                updatedBy: userEmail
            }, { merge: true });
        } catch (error) {
            console.error("Error setting queue status:", error);
            displayStatus("Failed to update queue status.", 'error');
        }
    };

    // --- FIREBASE OPERATIONS ---
    
    const checkSubmissionLimit = async () => {
        if (isReceptionistMode) return 0; 
        
        const q = query(
            getQueueCollectionRef(),
            where('submittedByUserId', '==', userId),
            where('queueDate', '==', todayYYYYMMDD)
        );
        
        const snapshot = await getDocs(q);
        return snapshot.size;
    }

    window.submitPatient = async (e) => {
        e.preventDefault();
        if (!isAuthenticated) return displayStatus("You must be signed in to join the queue.", 'error');
        if (isReceptionistMode) return displayStatus("Receptionists cannot use the patient form.", 'error');
        if (!isQueueOpen) return displayStatus("The queue is currently closed for new submissions today.", 'error');

        submitButton.disabled = true;
        submitButton.textContent = "Submitting...";
        
        try {
            const currentSubmissions = await checkSubmissionLimit();
            
            if (currentSubmissions >= MAX_PATIENT_SUBMISSIONS) {
                displayStatus(`Maximum submission limit (${MAX_PATIENT_SUBMISSIONS}) reached for today.`, 'error');
                submitButton.textContent = "Limit Reached";
                return;
            }

            const name = document.getElementById('name').value;
            const village = document.getElementById('village').value;
            const patientType = document.querySelector('input[name="patientType"]:checked').value;
            
            let subType = '';
            if (patientType === 'Old') {
                const subTypeEl = document.querySelector('input[name="subType"]:checked');
                subType = subTypeEl ? subTypeEl.value : '';
                if (!subType) throw new Error("Please select the Old Patient details.");
            }

            const newPatientData = {
                name: name.trim(),
                village: village.trim(),
                patientType: patientType,
                subType: subType,
                timestamp: serverTimestamp(),
                queueDate: todayYYYYMMDD, 
                status: 'Waiting',
                submittedByUserId: userId,
                submittedByName: name.trim() 
            };
            
            await addDoc(getQueueCollectionRef(), newPatientData);
            
            displayStatus("Successfully joined the queue!", 'success');
            
        } catch (error) {
            console.error("Error submitting patient:", error);
            displayStatus(`Submission failed: ${error.message || 'An unknown error occurred.'}`, 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Join Queue";
        }
    };
    
    window.updateStatus = async (docId, currentStatus) => {
        if (!isReceptionistMode) {
            return displayStatus("Only the Receptionist can change status.", 'error');
        }
        
        const newStatus = currentStatus === 'Waiting' ? 'Called' : 
                          currentStatus === 'Called' ? 'Completed' : 
                          'Waiting'; 
        
        try {
            const docRef = doc(getQueueCollectionRef(), docId);
            await updateDoc(docRef, { status: newStatus });
        } catch (error) {
            console.error("Error updating status:", error);
            displayStatus(`Failed to update status: ${error.message}`, 'error');
        }
    };

    window.deleteItem = async (docId) => {
        if (!isReceptionistMode) {
            return displayStatus("Only the Receptionist can delete items.", 'error');
        }
        
        console.warn(`Deleting document ID: ${docId}. Confirmation bypassed.`);
        
        try {
            const docRef = doc(getQueueCollectionRef(), docId);
            await deleteDoc(docRef);
        } catch (error) {
            console.error("Error deleting item:", error);
            displayStatus(`Failed to delete item: ${error.message}`, 'error');
        }
    };

    // --- REAL-TIME QUEUE LISTENER ---

    const updateQueueListener = () => {
        if (unsubscribeQueue) {
            unsubscribeQueue(); 
        }
        if (!isAuthenticated) return;

        // Queue is always for TODAY's date
        const q = query(
            getQueueCollectionRef(),
            where('queueDate', '==', todayYYYYMMDD), 
            where('status', 'in', ['Waiting', 'Called']) 
        );

        unsubscribeQueue = onSnapshot(q, (snapshot) => {
            let queue = [];
            let myPosition = null;
            let waitingCount = 0;
            let mySubmittedName = '';
            let myStatus = 'Cancelled';
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                data.id = doc.id;
                queue.push(data);
            });
            
            // 1. Client-Side Sorting: Sort by timestamp 
            queue.sort((a, b) => {
                const timeA = a.timestamp?.toMillis() || 0;
                const timeB = b.timestamp?.toMillis() || 0;
                return timeA - timeB;
            });

            // 2. Assign Queue Numbers and track position/counts
            queue.forEach((data, index) => {
                data.queueNumber = index + 1;
                
                if (data.status === 'Waiting') {
                    waitingCount++;
                }

                // Identify the current user's submission
                if (data.submittedByUserId === userId) {
                    myPosition = data.queueNumber;
                    mySubmittedName = data.submittedByName || 'Patient';
                    myStatus = data.status;
                }
            });
            
            if (isReceptionistMode) {
                renderQueue(queue);
            } else {
                // Ensure the list is empty/hidden for patients
                queueList.innerHTML = '';
            }

            renderMyQueuePosition(myPosition, waitingCount, mySubmittedName, myStatus);
        }, (error) => {
            console.error("Error listening to queue:", error);
        });
    };

    // --- RENDERING ---

    const renderMyQueuePosition = (myPosition, waitingCount, mySubmittedName, myStatus) => {
        queueCount.textContent = `${waitingCount} Waiting`;
        myName.textContent = mySubmittedName;

        if (myPosition) {
            patientQueueCard.classList.remove('hidden');
            myQueueNumber.textContent = myPosition;
            
            if (myStatus === 'Called') {
                myStatusDetail.textContent = "The receptionist has called you. Please proceed to the office.";
                patientQueueCard.classList.replace('bg-blue-600', 'bg-green-600');
                patientQueueCard.classList.replace('border-blue-400', 'border-green-400');
            } else if (myStatus === 'Waiting') {
                myStatusDetail.textContent = `There are ${myPosition - 1} patients ahead of you.`;
                patientQueueCard.classList.replace('bg-green-600', 'bg-blue-600');
                patientQueueCard.classList.replace('border-green-400', 'border-blue-400');
            } else {
                 // Should not happen for active queue items, but good fallback
                 patientQueueCard.classList.add('hidden');
            }
        } else if (!isReceptionistMode) {
            patientQueueCard.classList.add('hidden');
        }
    };

    const renderQueue = (queue) => {
        queueList.innerHTML = ''; 
        
        if (queue.length === 0) {
            emptyMessage.classList.remove('hidden');
            return;
        } else {
            emptyMessage.classList.add('hidden');
        }

        queue.forEach((item) => {
            const subDetail = item.subType ? `(${item.subType.split(' ')[0]})` : '';
            const statusColor = item.status === 'Waiting' ? 'bg-yellow-400' : 'bg-green-500';
            const statusText = item.status === 'Waiting' ? 'Waiting' : 'Called';
            
            const listItem = document.createElement('div');
            listItem.id = `queueItem-${item.queueNumber}`;
            listItem.className = `p-4 flex items-center justify-between rounded-lg ${item.submittedByUserId === userId ? 'bg-blue-100 border-blue-400 border-2' : 'bg-gray-50 border border-gray-200'}`;

            // Display the full user ID for troubleshooting/identification
            const fullUserIdDisplay = `User ID: ${item.submittedByUserId}`;

            listItem.innerHTML = `
                <div class="flex items-center space-x-4 w-11/12">
                    <span class="text-3xl font-extrabold ${item.submittedByUserId === userId ? 'text-blue-700' : 'text-gray-700'} w-10 text-center">${item.queueNumber}</span>
                    <div class="flex-grow">
                        <div class="font-bold text-gray-800">${item.name} (${item.village})</div>
                        <div class="text-sm text-gray-500" title="${fullUserIdDisplay}">${fullUserIdDisplay.substring(0, 30)}...</div>
                        <div class="text-xs text-gray-400">${item.patientType} ${subDetail}</div>
                    </div>
                    <span class="status-text ${statusColor} text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow-md">${statusText}</span>
                </div>
                
                <div class="flex space-x-2">
                    <button onclick="updateStatus('${item.id}', '${item.status}')" 
                            class="p-2 text-white text-sm rounded-full shadow-md transition duration-150 ${item.status === 'Called' ? 'bg-green-700 hover:bg-green-800' : 'bg-blue-500 hover:bg-blue-600'}"
                            title="${item.status === 'Called' ? 'Mark as Completed (Removes from queue)' : 'Mark as Called'}">
                        ${item.status === 'Called' ? '‚úî' : 'üìû'}
                    </button>
                    <button onclick="deleteItem('${item.id}')" 
                            class="p-2 bg-red-500 text-white text-sm rounded-full shadow-md hover:bg-red-600 transition duration-150"
                            title="Delete Item">
                        üóëÔ∏è
                    </button>
                </div>
            `;
            queueList.appendChild(listItem);
        });
    };

    // --- INITIAL SETUP ---
    initializeFirebase();
</script>
</body>
</html>